name: Custom Pack

on:
    workflow_dispatch:
        inputs:
            app_name:
                description: 'åº”ç”¨åç§° (ä¾‹å¦‚: YouTube, Twitter)'
                required: true
                type: string
            app_url:
                description: 'è¦æ‰“åŒ…çš„ç½‘é¡µ URL (ä¾‹å¦‚: https://www.youtube.com)'
                required: true
                type: string
            app_version:
                description: 'åº”ç”¨ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.0.1)'
                required: true
                type: string
                default: '0.0.1'
            app_identifier:
                description: 'åº”ç”¨æ ‡è¯†ç¬¦ (ä¾‹å¦‚: com.example.youtube)'
                required: true
                type: string
            window_width:
                description: 'çª—å£å®½åº¦ (åƒç´ )'
                required: false
                type: string
                default: '1200'
            window_height:
                description: 'çª—å£é«˜åº¦ (åƒç´ )'
                required: false
                type: string
                default: '800'
            debug_mode:
                description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
                required: false
                type: boolean
                default: false
            platforms:
                description: 'é€‰æ‹©æ‰“åŒ…å¹³å° (å¯å¤šé€‰: macos-arm, macos-intel, windows-x64, windows-arm, linux-x64, linux-arm)'
                required: false
                type: string
                default: 'macos-arm,windows-x64,linux-x64'
            inject_js:
                description: 'è‡ªå®šä¹‰ JS ä»£ç  (å¯é€‰ï¼Œç”¨äºæ³¨å…¥åˆ°é¡µé¢)'
                required: false
                type: string
                default: ''

jobs:
    # è§£æç”¨æˆ·é€‰æ‹©çš„å¹³å°
    prepare:
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.set-matrix.outputs.matrix }}
        steps:
            - name: è®¾ç½®æ„å»ºçŸ©é˜µ
              id: set-matrix
              run: |
                  platforms="${{ github.event.inputs.platforms }}"

                  # åˆå§‹åŒ–çŸ©é˜µæ•°ç»„
                  matrix='{"include":['

                  # æ ¹æ®ç”¨æˆ·é€‰æ‹©æ·»åŠ å¹³å°
                  if [[ "$platforms" == *"macos-arm"* ]]; then
                    matrix+='{"platform":"macos-latest","target":"aarch64-apple-darwin","args":"--target aarch64-apple-darwin","name":"macOS-ARM"},'
                  fi

                  if [[ "$platforms" == *"macos-intel"* ]]; then
                    matrix+='{"platform":"macos-latest","target":"x86_64-apple-darwin","args":"--target x86_64-apple-darwin","name":"macOS-Intel"},'
                  fi

                  if [[ "$platforms" == *"windows-x64"* ]]; then
                    matrix+='{"platform":"windows-latest","target":"x86_64-pc-windows-msvc","args":"","name":"Windows-x64"},'
                  fi

                  if [[ "$platforms" == *"windows-arm"* ]]; then
                    matrix+='{"platform":"windows-latest","target":"aarch64-pc-windows-msvc","args":"--target aarch64-pc-windows-msvc","name":"Windows-ARM"},'
                  fi

                  if [[ "$platforms" == *"linux-x64"* ]]; then
                    matrix+='{"platform":"ubuntu-22.04","target":"x86_64-unknown-linux-gnu","args":"","name":"Linux-x64"},'
                  fi

                  if [[ "$platforms" == *"linux-arm"* ]]; then
                    matrix+='{"platform":"ubuntu-22.04","target":"aarch64-unknown-linux-gnu","args":"--target aarch64-unknown-linux-gnu","name":"Linux-ARM"},'
                  fi

                  # ç§»é™¤æœ€åçš„é€—å·å¹¶é—­åˆ JSON
                  matrix="${matrix%,}]}"

                  echo "matrix=$matrix" >> $GITHUB_OUTPUT
                  echo "æ„å»ºçŸ©é˜µ: $matrix"

    # æ‰§è¡Œæ‰“åŒ…
    build:
        needs: prepare
        permissions:
            contents: write
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

        runs-on: ${{ matrix.platform }}
        timeout-minutes: 60

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… Rust ç›®æ ‡å¹³å°
              run: rustup target add ${{ matrix.target }}

            - name: è®¾ç½® pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: latest

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: pnpm

            - name: å®‰è£…å‰ç«¯ä¾èµ–
              run: pnpm install

            - name: å®‰è£… Rust å·¥å…·é“¾
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: ç”Ÿæˆä¸´æ—¶ç­¾åå¯†é’¥å¯¹
              shell: bash
              run: |
                  # ç”Ÿæˆä¸´æ—¶çš„ Tauri ç­¾åå¯†é’¥å¯¹ï¼ˆä»…ç”¨äºé€šè¿‡æ„å»ºéªŒè¯ï¼‰
                  echo "ç”Ÿæˆä¸´æ—¶ç­¾åå¯†é’¥å¯¹..."

                  # ä½¿ç”¨ pnpm tauri å‘½ä»¤ç”Ÿæˆå¯†é’¥
                  pnpm tauri signer generate -w /tmp/tauri_sign.key || {
                      echo "ä½¿ç”¨ pnpm ç”Ÿæˆå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ cargo..."
                      cargo install tauri-cli --version "^2.0.0" --locked
                      pnpm tauri signer generate -w /tmp/tauri_sign.key
                  }

                  # è¯»å–ç”Ÿæˆçš„å…¬é’¥å’Œç§é’¥
                  TAURI_PUBLIC_KEY=$(cat /tmp/tauri_sign.key.pub)
                  TAURI_PRIVATE_KEY=$(cat /tmp/tauri_sign.key)

                  echo "TAURI_PUBLIC_KEY=$TAURI_PUBLIC_KEY" >> $GITHUB_ENV
                  echo "TAURI_PRIVATE_KEY=$TAURI_PRIVATE_KEY" >> $GITHUB_ENV

                  echo "âœ… ä¸´æ—¶ç­¾åå¯†é’¥å·²ç”Ÿæˆ"

            - name: ä¿®æ”¹ Tauri é…ç½®
              shell: bash
              run: |
                  # å¤‡ä»½åŸé…ç½®
                  cp src-tauri/tauri.conf.json src-tauri/tauri.conf.json.backup

                  # ä½¿ç”¨ Node.js ä¿®æ”¹é…ç½®
                  node -e "
                  const fs = require('fs');
                  const config = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));

                  // ä¿®æ”¹åº”ç”¨åç§°å’Œæ ‡è¯†ç¬¦
                  config.productName = '${{ github.event.inputs.app_name }}';
                  config.identifier = '${{ github.event.inputs.app_identifier }}';

                  // ä½¿ç”¨ä¸´æ—¶å…¬é’¥æ›¿æ¢åŸæœ‰å…¬é’¥
                  if (config.plugins && config.plugins.updater) {
                      config.plugins.updater.pubkey = process.env.TAURI_PUBLIC_KEY || config.plugins.updater.pubkey;
                  }

                  // ä¿®æ”¹ç‰ˆæœ¬å·
                  const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
                  pkg.version = '${{ github.event.inputs.app_version }}';
                  fs.writeFileSync('package.json', JSON.stringify(pkg, null, 4));

                  // ä¿å­˜é…ç½®
                  fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(config, null, 4));
                  "

                  echo "âœ… Tauri é…ç½®å·²æ›´æ–°"

            - name: åˆ›å»ºå¯åŠ¨é¡µé¢é…ç½®
              shell: bash
              run: |
                  # åˆ›å»ºä¸´æ—¶ HTML æ–‡ä»¶ç”¨äºåŠ è½½ç›®æ ‡ç½‘é¡µ
                  cat > dist/index.html << 'EOF'
                  <!DOCTYPE html>
                  <html>
                  <head>
                      <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0">
                      <title>${{ github.event.inputs.app_name }}</title>
                      <style>
                          body, html { margin: 0; padding: 0; overflow: hidden; }
                          #app { width: 100vw; height: 100vh; }
                      </style>
                  </head>
                  <body>
                      <div id="app">åŠ è½½ä¸­...</div>
                      <script>
                          // è‡ªå®šä¹‰æ³¨å…¥çš„ JS
                          const customJS = `${{ github.event.inputs.inject_js }}`;

                          // é‡å®šå‘åˆ°ç›®æ ‡ URL
                          window.location.href = '${{ github.event.inputs.app_url }}';

                          // å¦‚æœæœ‰è‡ªå®šä¹‰ JSï¼Œåœ¨é¡µé¢åŠ è½½åæ‰§è¡Œ
                          if (customJS) {
                              window.addEventListener('load', () => {
                                  try {
                                      eval(customJS);
                                  } catch (e) {
                                      console.error('è‡ªå®šä¹‰ JS æ‰§è¡Œå¤±è´¥:', e);
                                  }
                              });
                          }
                      </script>
                  </body>
                  </html>
                  EOF

                  echo "âœ… å¯åŠ¨é¡µé¢å·²åˆ›å»º"

            - name: ç”Ÿæˆåº”ç”¨å›¾æ ‡
              run: pnpm tauri icon

            - name: åˆ›å»º macOS å›¾æ ‡ (ä»… macOS)
              if: matrix.platform == 'macos-latest'
              run: node ./scripts/creatIcon.cjs

            - name: å®‰è£… Linux ä¾èµ– (ä»… Linux)
              if: matrix.platform == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: æ„å»º Tauri åº”ç”¨
              env:
                  TAURI_SIGNING_PRIVATE_KEY: ${{ env.TAURI_PRIVATE_KEY }}
                  TAURI_SIGNING_PUBLIC_KEY: ${{ env.TAURI_PUBLIC_KEY }}
              run: |
                  if [ "${{ github.event.inputs.debug_mode }}" == "true" ]; then
                    pnpm tauri build --debug ${{ matrix.args }}
                  else
                    pnpm tauri build ${{ matrix.args }}
                  fi
              shell: bash

            - name: ä¸Šä¼ æ„å»ºäº§ç‰©
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ github.event.inputs.app_name }}-${{ matrix.name }}
                  path: |
                      src-tauri/target/*/release/bundle/**/*
                      src-tauri/target/*/debug/bundle/**/*
                  retention-days: 7

            - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              if: always()
              shell: bash
              run: |
                  # æ¢å¤åŸé…ç½®
                  if [ -f src-tauri/tauri.conf.json.backup ]; then
                    mv src-tauri/tauri.conf.json.backup src-tauri/tauri.conf.json
                  fi

                  # åˆ é™¤ä¸´æ—¶å¯†é’¥æ–‡ä»¶
                  rm -f /tmp/tauri_sign.key /tmp/tauri_sign.key.pub

    # åˆ›å»º Release
    create-release:
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: åˆ›å»º Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.event.inputs.app_name }}-v${{ github.event.inputs.app_version }}
                  name: ${{ github.event.inputs.app_name }} v${{ github.event.inputs.app_version }}
                  body: |
                      ## åº”ç”¨ä¿¡æ¯

                      - **åº”ç”¨åç§°**: ${{ github.event.inputs.app_name }}
                      - **ç‰ˆæœ¬**: ${{ github.event.inputs.app_version }}
                      - **ç›®æ ‡ URL**: ${{ github.event.inputs.app_url }}
                      - **çª—å£å°ºå¯¸**: ${{ github.event.inputs.window_width }}x${{ github.event.inputs.window_height }}
                      - **è°ƒè¯•æ¨¡å¼**: ${{ github.event.inputs.debug_mode }}

                      ## æ‰“åŒ…å¹³å°

                      ${{ github.event.inputs.platforms }}

                      ---

                      ğŸ¤– é€šè¿‡ GitHub Actions è‡ªåŠ¨æ„å»º
                  draft: false
                  prerelease: false
                  files: artifacts/**/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
